<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nagoya Trip 2026</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 FontAwesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Noto Sans JP (日式風格) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-cream': '#F9F8F4', // 米白色背景
                        'jp-stone': '#E6E4DD',
                        'jp-accent': '#8E8070', // 名古屋風格沈穩棕灰
                        'jp-dark': '#4A453F',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F9F8F4; }
        /* 隱藏 Scrollbar 但保留功能 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 模擬手機 App 的容器 */
        .app-container {
            max-width: 480px; /* 手機寬度限制 */
            margin: 0 auto;
            min-height: 100vh;
            background-color: #F9F8F4;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            position: relative;
            padding-bottom: 80px; /* 留給底部導航 */
        }
        
        /* 圓弧 Banner 設計 */
        .banner-container {
            height: 250px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }
        .banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 內容區塊向上拉動的圓弧效果 */
        .content-overlap {
            margin-top: -30px;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            background-color: #F9F8F4;
            position: relative;
            z-index: 10;
            padding: 20px;
            min-height: 500px;
        }
    </style>
</head>
<body>

<div id="app" class="app-container">
    
    <!-- 頁首 Banner (只有在首頁和行程頁顯示) -->
    <div v-if="currentTab !== 'info' && currentTab !== 'cost'" class="banner-container">
        <!-- 請將 src 改為你的圖片檔名 -->
        <img src="https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1920&auto=format&fit=crop" alt="Nagoya" class="banner-img">
        <div class="absolute inset-0 bg-black/20"></div> <!-- 輕微遮罩 -->
    </div>

    <!-- 主內容區域 -->
    <div :class="{'content-overlap': currentTab !== 'info' && currentTab !== 'cost', 'p-5 pt-10': currentTab === 'info' || currentTab === 'cost'}">
        
        <!-- ==================== Tab 1: 首頁總覽 ==================== -->
        <div v-if="currentTab === 'home'" class="animate-fade-in">
            <!-- 旅程資訊 -->
            <div class="text-center mb-8">
                <h2 class="text-jp-accent tracking-widest text-sm font-bold mb-1">DESTINATION</h2>
                <h1 class="text-4xl font-light text-jp-dark mb-2">NAGOYA</h1>
                <div class="inline-block bg-white px-4 py-1 rounded-full shadow-sm text-sm text-jp-dark border border-jp-stone">
                    {{ countdownText }}
                </div>
            </div>

            <!-- 航班資訊 -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-jp-stone/50 mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                    <span class="text-xs font-bold text-jp-accent">FLIGHTS</span>
                    <i class="fas fa-plane text-jp-accent"></i>
                </div>
                <!-- 去程 -->
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center">
                        <div class="text-2xl font-light text-jp-dark">HKG</div>
                        <div class="text-xs text-gray-400">10:00</div>
                    </div>
                    <div class="flex-1 px-4 text-center">
                        <div class="text-xs text-gray-400">UO680</div>
                        <div class="border-t border-gray-300 w-full my-1 relative">
                            <i class="fas fa-plane absolute top-[-8px] left-1/2 -translate-x-1/2 text-gray-300 text-xs transform rotate-90"></i>
                        </div>
                        <div class="text-xs text-gray-400">3h 30m</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-light text-jp-dark">NGO</div>
                        <div class="text-xs text-gray-400">14:30</div>
                    </div>
                </div>
                <!-- 回程 -->
                <div class="flex justify-between items-center">
                    <div class="text-center">
                        <div class="text-2xl font-light text-jp-dark">NGO</div>
                    </div>
                    <div class="flex-1 px-4 text-center">
                        <div class="text-xs text-gray-400">UO685</div>
                        <div class="border-t border-gray-300 w-full my-1"></div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-light text-jp-dark">HKG</div>
                    </div>
                </div>
            </div>

            <!-- 名古屋即時天氣 (API Fetch) -->
            <div class="bg-gradient-to-br from-[#8E8070] to-[#6d6255] rounded-2xl p-5 shadow-lg text-white">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <div class="text-xs opacity-80 mb-1">NAGOYA WEATHER</div>
                        <div class="text-3xl font-light">{{ currentWeather.temp }}°C</div>
                    </div>
                    <div class="text-4xl opacity-90">
                        <i :class="getWeatherIcon(currentWeather.code)"></i>
                    </div>
                </div>
                <!-- 橫向 4 小時預報 -->
                <div class="grid grid-cols-4 gap-2 border-t border-white/20 pt-3">
                    <div v-for="(h, index) in forecastHours" :key="index" class="text-center">
                        <div class="text-xs opacity-70 mb-1">{{ h.time }}</div>
                        <i :class="getWeatherIcon(h.code)" class="text-lg mb-1"></i>
                        <div class="text-sm font-medium">{{ h.temp }}°</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== Tab 2: 每日行程表 ==================== -->
        <div v-if="currentTab === 'itinerary'" class="relative pb-20">
            <!-- 天氣概況 Header -->
            <div class="flex items-center justify-between mb-4 px-1">
                <div>
                    <span class="text-3xl font-light text-jp-dark">{{ selectedDateObj.temp }}°</span>
                    <span class="text-xs text-gray-400 ml-2">體感 {{ selectedDateObj.feelsLike }}°</span>
                </div>
                <div class="text-jp-accent text-2xl">
                    <i :class="getWeatherIcon(selectedDateObj.weatherCode)"></i>
                </div>
            </div>

            <!-- 日期選擇器 (橫向滑動) -->
            <div class="flex overflow-x-auto hide-scrollbar gap-3 mb-6 pb-2">
                <div 
                    v-for="(day, index) in itineraryDays" 
                    :key="index"
                    @click="selectDate(index)"
                    :class="['flex flex-col items-center justify-center min-w-[60px] h-[70px] rounded-xl transition-all cursor-pointer border', 
                             currentDayIndex === index ? 'bg-jp-accent text-white border-jp-accent shadow-md' : 'bg-white text-gray-400 border-transparent']"
                >
                    <span class="text-xs font-medium uppercase">{{ day.weekDay }}</span>
                    <span class="text-xl font-bold">{{ day.dateNum }}</span>
                </div>
            </div>

            <!-- 行程列表 -->
            <div class="space-y-0">
                <div v-for="(item, index) in currentItinerary" :key="item.id" class="relative group">
                    
                    <!-- 1. 卡片本體區塊 -->
                    <div class="flex gap-4 items-stretch">
                        <!-- 左側時間軸 (只顯示點跟時間，不連線) -->
                        <div class="flex flex-col items-center pt-2 min-w-[50px]">
                            <div class="text-xs font-bold text-jp-dark mb-1">{{ item.startTime }}</div>
                            <div :class="['w-3 h-3 rounded-full border-2 border-white shadow-sm z-10', getCategoryColor(item.category)]"></div>
                            <!-- 只有當不是最後一個，且沒有交通區塊時才顯示一點點輔助線(這裡選擇留白比較極簡) -->
                        </div>

                        <!-- 右側卡片 -->
                        <div @click="openMap(item.name)" class="flex-1 bg-white rounded-xl p-4 shadow-sm border border-gray-100 active:scale-95 transition-transform cursor-pointer relative overflow-hidden mb-0">
                            <!-- 類別標籤 -->
                            <div :class="['absolute right-0 top-0 px-2 py-1 text-[10px] text-white rounded-bl-lg', getCategoryColor(item.category)]">
                                {{ getCategoryName(item.category) }}
                            </div>

                            <!-- 內容 -->
                            <div v-if="item.category === 'flight'">
                                <div class="text-sm font-bold text-jp-dark mb-1">{{ item.name }}</div>
                                <div class="flex items-center gap-4 text-xs text-gray-500 mt-2">
                                    <span><i class="fas fa-plane-departure mr-1"></i> {{ item.startTime }}</span>
                                    <span><i class="fas fa-plane-arrival mr-1"></i> {{ item.endTime }}</span>
                                </div>
                                <div class="mt-2 text-xs bg-gray-50 p-2 rounded text-gray-600">{{ item.note }}</div>
                            </div>
                            <div v-else>
                                <h3 class="font-bold text-jp-dark text-base mb-1 pr-8">{{ item.name }}</h3>
                                <div v-if="item.hours" class="text-xs text-gray-500 mb-1">
                                    <i class="far fa-clock mr-1"></i> {{ item.hours }}
                                </div>
                                <div v-if="item.ticket" class="text-xs text-orange-400 mb-1">
                                    <i class="fas fa-ticket-alt mr-1"></i> {{ item.ticket }}
                                </div>
                                <p v-if="item.note" class="text-xs text-gray-400 mt-2 line-clamp-2">
                                    {{ item.note }}
                                </p>
                            </div>
                            
                            <!-- 編輯按鈕 -->
                            <button @click.stop="openEditModal(item)" class="absolute bottom-2 right-2 text-gray-300 hover:text-jp-accent p-2">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 2. 卡片之間的交通資訊 (顯示在下方，除了最後一個) -->
                    <div v-if="index < currentItinerary.length - 1" class="flex gap-4 my-1">
                        <!-- 左側為了對齊，留白 -->
                        <div class="min-w-[50px]"></div>
                        
                        <!-- 右側交通資訊區塊 -->
                        <div class="flex-1 flex flex-col items-center justify-center">
                            <div class="h-3 w-px bg-gray-200"></div> <!-- 連接上方的線 -->
                            
                            <!-- 交通膠囊 -->
                            <div class="flex items-center gap-2 text-[10px] text-gray-500 bg-white px-3 py-1 rounded-full border border-gray-200 shadow-sm">
                                <i :class="[getTransportIcon(item.nextTransportType), 'text-jp-accent']"></i>
                                <span>{{ item.nextTransportTime }}</span>
                            </div>
                            
                            <div class="h-3 w-px bg-gray-200"></div> <!-- 連接下方的線 -->
                        </div>
                    </div>

                </div>
            </div>

            <!-- 新增按鈕 -->
            <button @click="openAddModal" class="fixed bottom-24 right-6 w-14 h-14 bg-jp-accent text-white rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-jp-dark transition-colors z-30">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- ==================== Tab 3: 資訊 ==================== -->
        <div v-if="currentTab === 'info'" class="space-y-4">
            <h2 class="text-2xl font-light text-jp-dark mb-6">住宿 & 資訊</h2>
            
            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <h3 class="font-bold text-jp-dark mb-3"><i class="fas fa-home text-jp-accent mr-2"></i>住宿資訊</h3>
                <p class="font-medium">VIVA APARTMENT YABACHO</p>
                <p class="text-sm text-gray-500 mt-1">Airbnb</p>
                <div class="mt-3 text-xs text-gray-400 bg-gray-50 p-3 rounded-lg flex justify-between items-start">
                    <span>5 Chome-12 Sakae, Naka Ward, Nagoya</span>
                    <button @click="openMap('VIVA APARTMENT YABACHO')" class="text-jp-accent ml-2"><i class="fas fa-location-arrow"></i></button>
                </div>
            </div>

            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                <h3 class="font-bold text-jp-dark mb-3"><i class="fas fa-suitcase text-jp-accent mr-2"></i>行前清單</h3>
                <ul class="text-sm text-gray-600 space-y-2">
                    <li class="flex items-center"><i class="far fa-check-circle text-green-500 mr-2"></i> 護照</li>
                    <li class="flex items-center"><i class="far fa-check-circle text-green-500 mr-2"></i> Visit Japan Web</li>
                    <li class="flex items-center"><i class="far fa-circle text-gray-300 mr-2"></i> 網卡 / Roaming</li>
                </ul>
            </div>
        </div>
        
        <!-- ==================== Tab 4: 花費 ==================== -->
        <div v-if="currentTab === 'cost'" class="text-center pt-20 text-gray-400">
            <i class="fas fa-yen-sign text-4xl mb-4"></i>
            <p>記帳功能開發中</p>
        </div>

    </div>

    <!-- 底部導航欄 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 h-20 pb-4 flex justify-around items-center z-40 max-w-[480px] mx-auto text-[10px]">
        <button @click="currentTab = 'home'" :class="['flex flex-col items-center w-full h-full justify-center', currentTab === 'home' ? 'text-jp-accent' : 'text-gray-300']">
            <i class="fas fa-home text-xl mb-1"></i>
            <span>首頁</span>
        </button>
        <button @click="currentTab = 'itinerary'" :class="['flex flex-col items-center w-full h-full justify-center', currentTab === 'itinerary' ? 'text-jp-accent' : 'text-gray-300']">
            <i class="fas fa-map-marked-alt text-xl mb-1"></i>
            <span>行程</span>
        </button>
        <button @click="currentTab = 'info'" :class="['flex flex-col items-center w-full h-full justify-center', currentTab === 'info' ? 'text-jp-accent' : 'text-gray-300']">
            <i class="fas fa-info-circle text-xl mb-1"></i>
            <span>資訊</span>
        </button>
        <button @click="currentTab = 'cost'" :class="['flex flex-col items-center w-full h-full justify-center', currentTab === 'cost' ? 'text-jp-accent' : 'text-gray-300']">
            <i class="fas fa-coins text-xl mb-1"></i>
            <span>花費</span>
        </button>
    </div>

    <!-- 彈出視窗：新增/編輯行程 -->
    <div v-if="showModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-fade-in-up">
            <h3 class="text-xl font-bold text-jp-dark mb-4">{{ isEditing ? '編輯行程' : '新增行程' }}</h3>
            
            <div class="space-y-3">
                <input v-model="form.name" placeholder="名稱" class="w-full p-2 bg-gray-50 rounded border border-gray-200 focus:outline-none focus:border-jp-accent">
                
                <div class="flex gap-2">
                    <select v-model="form.category" class="flex-1 p-2 bg-gray-50 rounded border border-gray-200">
                        <option value="sightseeing">景點</option>
                        <option value="stay">住宿</option>
                        <option value="food">美食</option>
                        <option value="shopping">購物</option>
                        <option value="flight">航班</option>
                        <option value="other">其他</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <input v-model="form.startTime" type="text" placeholder="開始 (00:00)" class="flex-1 p-2 bg-gray-50 rounded border border-gray-200">
                    <input v-model="form.endTime" type="text" placeholder="結束 (00:00)" class="flex-1 p-2 bg-gray-50 rounded border border-gray-200">
                </div>

                <input v-model="form.hours" placeholder="營業時間" class="w-full p-2 bg-gray-50 rounded border border-gray-200">
                <input v-model="form.ticket" placeholder="門票資訊" class="w-full p-2 bg-gray-50 rounded border border-gray-200">
                <textarea v-model="form.note" placeholder="備註" class="w-full p-2 bg-gray-50 rounded border border-gray-200 h-20"></textarea>
                
                <!-- 交通時間設定 (到下一個點) -->
                <div class="bg-gray-50 p-2 rounded">
                    <label class="text-xs text-gray-500 block mb-1">前往下個點的交通</label>
                    <div class="flex gap-2">
                        <select v-model="form.nextTransportType" class="p-1 rounded border text-sm">
                            <option value="walk">步行</option>
                            <option value="train">大眾運輸</option>
                            <option value="car">開車</option>
                        </select>
                        <input v-model="form.nextTransportTime" placeholder="例如: 10分鐘" class="flex-1 p-1 rounded border text-sm">
                    </div>
                </div>

                <!-- 排序功能 -->
                <div v-if="isEditing" class="flex justify-between items-center border-t border-gray-100 pt-3 mt-2">
                    <span class="text-xs text-gray-400">排序移動</span>
                    <div class="flex gap-2">
                        <button @click="moveItem(-1)" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fas fa-arrow-up text-xs"></i></button>
                        <button @click="moveItem(1)" class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200"><i class="fas fa-arrow-down text-xs"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button v-if="isEditing" @click="confirmDelete" class="flex-1 py-3 text-red-400 bg-red-50 rounded-xl font-bold">刪除</button>
                <button @click="showModal = false" class="flex-1 py-3 text-gray-500 bg-gray-100 rounded-xl font-bold">取消</button>
                <button @click="saveItem" class="flex-1 py-3 bg-jp-accent text-white rounded-xl font-bold">儲存</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const currentTab = ref('home');
            const showModal = ref(false);
            const isEditing = ref(false);
            const currentDayIndex = ref(0);
            
            // 天氣資料
            const currentWeather = ref({ temp: 12, code: 3 }); 
            const forecastHours = ref([
                { time: '13:00', code: 1, temp: 13 },
                { time: '14:00', code: 0, temp: 14 },
                { time: '15:00', code: 2, temp: 13 },
                { time: '16:00', code: 3, temp: 11 },
            ]);

            // 日期設定 (2026/01/06)
            const itineraryDays = ref([
                { date: '2026-01-06', weekDay: 'Tue', dateNum: '6', temp: 10, feelsLike: 8, weatherCode: 1 },
                { date: '2026-01-07', weekDay: 'Wed', dateNum: '7', temp: 9, feelsLike: 7, weatherCode: 3 },
                { date: '2026-01-08', weekDay: 'Thu', dateNum: '8', temp: 11, feelsLike: 9, weatherCode: 0 },
            ]);

            // 行程資料
            const allItinerary = ref({
                '2026-01-06': [
                    { id: 1, name: 'Hong Kong Intl Airport T1', category: 'flight', startTime: '07:30', endTime: '10:00', note: 'Check-in & Security', nextTransportType: 'flight', nextTransportTime: '3.5hr' },
                    { id: 2, name: '航班 UO680 (HKG-NGO)', category: 'flight', startTime: '10:00', endTime: '14:30', note: '機上休息', nextTransportType: 'walk', nextTransportTime: '0分' },
                    { id: 3, name: 'Chubu Intl Airport T2', category: 'other', startTime: '14:30', endTime: '15:30', note: '入境手續', nextTransportType: 'walk', nextTransportTime: '5分鐘' },
                    { id: 4, name: '波音博物館 FLIGHT OF DREAMS', category: 'sightseeing', startTime: '15:35', endTime: '16:00', ticket: 'Free (部分區域)', hours: '10:00-17:00', note: '看第一架波音787', nextTransportType: 'train', nextTransportTime: '60分鐘' },
                    { id: 5, name: 'VIVA APARTMENT YABACHO', category: 'stay', startTime: '17:00', endTime: '18:00', note: 'Check-in, 放行李', nextTransportType: 'walk', nextTransportTime: '10分鐘' },
                    { id: 6, name: '矢場丼 矢場町本店', category: 'food', startTime: '18:10', endTime: '19:00', hours: '11:00-21:00', note: '必吃味噌豬排', nextTransportType: 'walk', nextTransportTime: '10分鐘' },
                    { id: 7, name: '榮商圈', category: 'shopping', startTime: '19:10', endTime: '20:30', note: 'Donki, 百貨公司', nextTransportType: 'walk', nextTransportTime: '10分鐘' },
                    { id: 8, name: 'VIVA APARTMENT YABACHO', category: 'stay', startTime: '21:10', endTime: '22:00', note: '休息', nextTransportType: 'none', nextTransportTime: '' },
                ]
            });

            const form = ref({ id: null, name: '', category: 'sightseeing', startTime: '', endTime: '', note: '', ticket: '', hours: '', nextTransportType: 'walk', nextTransportTime: '' });

            const selectedDateKey = computed(() => itineraryDays.value[currentDayIndex.value].date);
            const selectedDateObj = computed(() => itineraryDays.value[currentDayIndex.value]);
            const currentItinerary = computed(() => allItinerary.value[selectedDateKey.value] || []);

            const countdownText = computed(() => {
                const target = new Date('2026-01-06');
                const now = new Date();
                const diff = Math.ceil((target - now) / (1000 * 60 * 60 * 24));
                if (diff > 0) return `距離旅程還有 ${diff} 天`;
                if (diff <= 0 && diff > -5) return `旅程進行中 Day ${Math.abs(diff) + 1}`;
                return `旅程結束`;
            });

            const selectDate = (index) => {
                currentDayIndex.value = index;
            };

            const getCategoryColor = (cat) => {
                const map = {
                    sightseeing: 'bg-orange-400',
                    stay: 'bg-indigo-400',
                    food: 'bg-rose-400',
                    shopping: 'bg-pink-400',
                    flight: 'bg-blue-400',
                    other: 'bg-gray-400'
                };
                return map[cat] || 'bg-gray-400';
            };
            
            const getCategoryName = (cat) => {
                const map = { sightseeing: '景點', stay: '住宿', food: '美食', shopping: '購物', flight: '航班', other: '其他' };
                return map[cat];
            };

            const getWeatherIcon = (code) => {
                if (code <= 1) return 'fas fa-sun text-orange-400';
                if (code <= 3) return 'fas fa-cloud text-gray-400';
                if (code <= 60) return 'fas fa-cloud-rain text-blue-400';
                return 'fas fa-snowflake text-cyan-300';
            };

            const getTransportIcon = (type) => {
                if (type === 'train') return 'fas fa-subway';
                if (type === 'car') return 'fas fa-car';
                if (type === 'flight') return 'fas fa-plane';
                return 'fas fa-walking';
            };

            const fetchWeather = async () => {
                try {
                    const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.1815&longitude=136.9066&current_weather=true&hourly=temperature_2m,weathercode&timezone=Asia%2FTokyo');
                    const data = await res.json();
                    
                    currentWeather.value = {
                        temp: Math.round(data.current_weather.temperature),
                        code: data.current_weather.weathercode
                    };

                    const currentHour = new Date().getHours();
                    const hours = [];
                    for(let i=1; i<=4; i++) {
                        let hIndex = (currentHour + i) % 24;
                        hours.push({
                            time: `${hIndex}:00`,
                            temp: Math.round(data.hourly.temperature_2m[hIndex]),
                            code: data.hourly.weathercode[hIndex]
                        });
                    }
                    forecastHours.value = hours;

                } catch (e) {
                    console.error("Weather fetch failed", e);
                }
            };

            const openMap = (name) => {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name + ' 名古屋')}`, '_blank');
            };

            const openAddModal = () => {
                isEditing.value = false;
                form.value = { category: 'sightseeing', nextTransportType: 'walk', startTime: '', endTime: '', id: Date.now() }; 
                showModal.value = true;
            };

            const openEditModal = (item) => {
                isEditing.value = true;
                form.value = { ...item }; 
                showModal.value = true;
            };

            const saveItem = () => {
                const list = allItinerary.value[selectedDateKey.value] || [];
                if (isEditing.value) {
                    const idx = list.findIndex(i => i.id === form.value.id);
                    if (idx !== -1) list[idx] = { ...form.value };
                } else {
                    if (!allItinerary.value[selectedDateKey.value]) allItinerary.value[selectedDateKey.value] = [];
                    allItinerary.value[selectedDateKey.value].push({ ...form.value, id: Date.now() });
                }
                showModal.value = false;
            };

            const confirmDelete = () => {
                if (confirm('確定要刪除此行程嗎？')) {
                    const list = allItinerary.value[selectedDateKey.value];
                    const idx = list.findIndex(i => i.id === form.value.id);
                    if (idx !== -1) list.splice(idx, 1);
                    showModal.value = false;
                }
            };

            const moveItem = (direction) => {
                const list = allItinerary.value[selectedDateKey.value];
                const idx = list.findIndex(i => i.id === form.value.id);
                if (idx === -1) return;
                
                const newIdx = idx + direction;
                if (newIdx >= 0 && newIdx < list.length) {
                    const temp = list[idx];
                    list[idx] = list[newIdx];
                    list[newIdx] = temp;
                }
            };

            onMounted(() => {
                fetchWeather();
            });

            return {
                currentTab, countdownText, currentWeather, forecastHours,
                itineraryDays, currentDayIndex, currentItinerary, selectedDateObj,
                showModal, isEditing, form,
                selectDate, getCategoryColor, getCategoryName, getWeatherIcon, getTransportIcon,
                openMap, openAddModal, openEditModal, saveItem, confirmDelete, moveItem
            };
        }
    }).mount('#app');
</script>
</body>
</html>
